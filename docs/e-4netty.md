

## 5.4 Netty é¢è¯•é¢˜æ€»ç»“

### 5.4.1 Netty æ˜¯ä»€ä¹ˆï¼Ÿ

- Netty æ˜¯ä¸€ä¸ª åŸºäº NIO çš„ client-server(å®¢æˆ·ç«¯æœåŠ¡å™¨)æ¡†æ¶ï¼Œä½¿ç”¨å®ƒå¯ä»¥å¿«é€Ÿç®€å•åœ°å¼€å‘ç½‘ç»œåº”ç”¨ç¨‹åº
- æ”¯æŒå¤šç§åè®® å¦‚ FTPï¼ŒSMTPï¼ŒHTTP ä»¥åŠå„ç§äºŒè¿›åˆ¶å’ŒåŸºäºæ–‡æœ¬çš„ä¼ ç»Ÿåè®®ã€‚
- Nettyæ˜¯åŸºäºnioçš„ï¼Œå®ƒå°è£…äº†jdkçš„nioï¼Œè®©æˆ‘ä»¬ä½¿ç”¨èµ·æ¥æ›´åŠ æ–¹ä¾¿çµæ´»ã€‚

å¾ˆå¤šå¼€æºé¡¹ç›®æ¯”å¦‚æˆ‘ä»¬å¸¸ç”¨çš„ Dubboã€RocketMQã€Elasticsearch ç­‰ç­‰éƒ½ç”¨åˆ°äº† Netty

### 5.4.2 Nettyçš„ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

- é«˜å¹¶å‘ï¼šNetty æ˜¯ä¸€æ¬¾åŸºäº NIOï¼ˆNonblocking IOï¼Œéé˜»å¡IOï¼‰å¼€å‘çš„ç½‘ç»œé€šä¿¡æ¡†æ¶ï¼Œå¯¹æ¯”äº BIOï¼ˆBlocking I/Oï¼Œé˜»å¡IOï¼‰ï¼Œä»–çš„å¹¶å‘æ€§èƒ½å¾—åˆ°äº†å¾ˆå¤§æé«˜ã€‚
- ä¼ è¾“å¿«ï¼šNetty çš„ä¼ è¾“ä¾èµ–äºé›¶æ‹·è´ç‰¹æ€§ï¼Œå°½é‡å‡å°‘ä¸å¿…è¦çš„å†…å­˜æ‹·è´ï¼Œå®ç°äº†æ›´é«˜æ•ˆç‡çš„ä¼ è¾“ã€‚
- å°è£…å¥½ï¼šNetty å°è£…äº† NIO æ“ä½œçš„å¾ˆå¤šç»†èŠ‚ï¼Œæä¾›äº†æ˜“äºä½¿ç”¨è°ƒç”¨æ¥å£ã€‚

- ä½¿ç”¨ç®€å•ï¼šå°è£…äº† NIO çš„å¾ˆå¤šç»†èŠ‚ï¼Œä½¿ç”¨æ›´ç®€å•ã€‚
- åŠŸèƒ½å¼ºå¤§ï¼šè‡ªå¸¦ç¼–è§£ç å™¨è§£å†³ TCP ç²˜åŒ…/æ‹†åŒ…é—®é¢˜ã€‚
- å®šåˆ¶èƒ½åŠ›å¼ºï¼šå¯ä»¥é€šè¿‡ ChannelHandler å¯¹é€šä¿¡æ¡†æ¶è¿›è¡Œçµæ´»åœ°æ‰©å±•ã€‚
- æ€§èƒ½é«˜ï¼šæ›´é«˜çš„ååé‡ã€æ›´ä½çš„å»¶è¿Ÿã€æ›´ä½çš„èµ„æºæ¶ˆè€—å’Œæ›´å°‘çš„å†…å­˜å¤åˆ¶ã€‚
- ç¨³å®šï¼šNetty ä¿®å¤äº†å·²ç»å‘ç°çš„æ‰€æœ‰ NIO çš„ bugï¼Œè®©å¼€å‘äººå‘˜å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡æœ¬èº«ã€‚
- ç¤¾åŒºæ´»è·ƒï¼šNetty æ˜¯æ´»è·ƒçš„å¼€æºé¡¹ç›®ï¼Œç‰ˆæœ¬è¿­ä»£å‘¨æœŸçŸ­ï¼Œbug ä¿®å¤é€Ÿåº¦å¿«ã€‚

### 5.4.3 Netty åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ

å…¸å‹çš„åº”ç”¨æœ‰ï¼šé˜¿é‡Œåˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶ Dubboï¼Œé»˜è®¤ä½¿ç”¨ Netty ä½œä¸ºåŸºç¡€é€šä¿¡ç»„ä»¶ï¼Œè¿˜æœ‰ RocketMQ ä¹Ÿæ˜¯ä½¿ç”¨ Netty ä½œä¸ºé€šè®¯çš„åŸºç¡€ã€‚

Netty ä¸»è¦ç”¨æ¥åš**ç½‘ç»œé€šä¿¡** :

- **ä½œä¸º RPC æ¡†æ¶çš„ç½‘ç»œé€šä¿¡å·¥å…·** ï¼š æˆ‘ä»¬åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸åŒæœåŠ¡èŠ‚ç‚¹ä¹‹é—´ç»å¸¸éœ€è¦ç›¸äº’è°ƒç”¨ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ RPC æ¡†æ¶äº†ã€‚ä¸åŒæœåŠ¡èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡æ˜¯å¦‚ä½•åšçš„å‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨ Netty æ¥åšã€‚æ¯”å¦‚æˆ‘è°ƒç”¨å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹çš„æ–¹æ³•çš„è¯ï¼Œè‡³å°‘æ˜¯è¦è®©å¯¹æ–¹çŸ¥é“æˆ‘è°ƒç”¨çš„æ˜¯å“ªä¸ªç±»ä¸­çš„å“ªä¸ªæ–¹æ³•ä»¥åŠç›¸å…³å‚æ•°å§ï¼
- **å®ç°ä¸€ä¸ªè‡ªå·±çš„ HTTP æœåŠ¡å™¨** ï¼šé€šè¿‡ Netty æˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ªç®€å•çš„ HTTP æœåŠ¡å™¨ï¼Œè¿™ä¸ªå¤§å®¶åº”è¯¥ä¸é™Œç”Ÿã€‚è¯´åˆ° HTTP æœåŠ¡å™¨çš„è¯ï¼Œä½œä¸º Java åç«¯å¼€å‘ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ Tomcat æ¯”è¾ƒå¤šã€‚ä¸€ä¸ªæœ€åŸºæœ¬çš„ HTTP æœåŠ¡å™¨å¯è¦ä»¥å¤„ç†å¸¸è§çš„ HTTP Method çš„è¯·æ±‚ï¼Œæ¯”å¦‚ POST è¯·æ±‚ã€GET è¯·æ±‚ç­‰ç­‰ã€‚
- **å®ç°ä¸€ä¸ªå³æ—¶é€šè®¯ç³»ç»Ÿ** ï¼š ä½¿ç”¨ Netty æˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªå¯ä»¥èŠå¤©ç±»ä¼¼å¾®ä¿¡çš„å³æ—¶é€šè®¯ç³»ç»Ÿ

### 5.4.4Netty æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿåˆ†åˆ«æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ

#### 1.Channel

`Channel` æ¥å£æ˜¯ Netty å¯¹ç½‘ç»œæ“ä½œæŠ½è±¡ç±»ï¼Œå®ƒé™¤äº†åŒ…æ‹¬åŸºæœ¬çš„ I/O æ“ä½œï¼Œå¦‚ `bind()`ã€`connect()`ã€`read()`ã€`write()` ç­‰ã€‚

æ¯”è¾ƒå¸¸ç”¨çš„`Channel`æ¥å£å®ç°ç±»æ˜¯`NioServerSocketChannel`ï¼ˆæœåŠ¡ç«¯ï¼‰å’Œ`NioSocketChannel`ï¼ˆå®¢æˆ·ç«¯ï¼‰ï¼Œè¿™ä¸¤ä¸ª `Channel` å¯ä»¥å’Œ BIO ç¼–ç¨‹æ¨¡å‹ä¸­çš„`ServerSocket`ä»¥åŠ`Socket`ä¸¤ä¸ªæ¦‚å¿µå¯¹åº”ä¸Šã€‚Netty çš„ `Channel` æ¥å£æ‰€æä¾›çš„ APIï¼Œå¤§å¤§åœ°é™ä½äº†ç›´æ¥ä½¿ç”¨ Socket ç±»çš„å¤æ‚æ€§ã€‚

#### 2.EventLoop

è¿™ä¹ˆè¯´å§ï¼`EventLoop`ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰æ¥å£å¯ä»¥è¯´æ˜¯ Netty ä¸­æœ€æ ¸å¿ƒçš„æ¦‚å¿µäº†ï¼

ã€ŠNetty å®æˆ˜ã€‹è¿™æœ¬ä¹¦æ˜¯è¿™æ ·ä»‹ç»å®ƒçš„ï¼š

> `EventLoop` å®šä¹‰äº† Netty çš„æ ¸å¿ƒæŠ½è±¡ï¼Œç”¨äºå¤„ç†è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸä¸­æ‰€å‘ç”Ÿçš„äº‹ä»¶ã€‚

æ˜¯ä¸æ˜¯å¾ˆéš¾ç†è§£ï¼Ÿè¯´å®è¯ï¼Œæˆ‘å­¦ä¹  Netty çš„æ—¶å€™çœ‹åˆ°è¿™å¥è¯æ˜¯æ²¡å¤ªèƒ½ç†è§£çš„ã€‚

è¯´ç™½äº†ï¼Œ**`EventLoop` çš„ä¸»è¦ä½œç”¨å®é™…å°±æ˜¯è´Ÿè´£ç›‘å¬ç½‘ç»œäº‹ä»¶å¹¶è°ƒç”¨äº‹ä»¶å¤„ç†å™¨è¿›è¡Œç›¸å…³ I/O æ“ä½œçš„å¤„ç†ã€‚**

é‚£ `Channel` å’Œ `EventLoop` ç›´æ¥æœ‰å•¥è”ç³»å‘¢ï¼Ÿ

`Channel` ä¸º Netty ç½‘ç»œæ“ä½œ(è¯»å†™ç­‰æ“ä½œ)æŠ½è±¡ç±»ï¼Œ`EventLoop` è´Ÿè´£å¤„ç†æ³¨å†Œåˆ°å…¶ä¸Šçš„`Channel` å¤„ç† I/O æ“ä½œï¼Œä¸¤è€…é…åˆå‚ä¸ I/O æ“ä½œã€‚

#### 3.ChannelFuture

Netty æ˜¯å¼‚æ­¥éé˜»å¡çš„ï¼Œæ‰€æœ‰çš„ I/O æ“ä½œéƒ½ä¸ºå¼‚æ­¥çš„ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬ä¸èƒ½ç«‹åˆ»å¾—åˆ°æ“ä½œæ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œä½†æ˜¯ï¼Œä½ å¯ä»¥é€šè¿‡ `ChannelFuture` æ¥å£çš„ `addListener()` æ–¹æ³•æ³¨å†Œä¸€ä¸ª `ChannelFutureListener`ï¼Œå½“æ“ä½œæ‰§è¡ŒæˆåŠŸæˆ–è€…å¤±è´¥æ—¶ï¼Œç›‘å¬å°±ä¼šè‡ªåŠ¨è§¦å‘è¿”å›ç»“æœã€‚

å¹¶ä¸”ï¼Œä½ è¿˜å¯ä»¥é€šè¿‡`ChannelFuture` çš„ `channel()` æ–¹æ³•è·å–å…³è”çš„`Channel`

```java
public interface ChannelFuture extends Future<Void> {
    Channel channel();

    ChannelFuture addListener(GenericFutureListener<? extends Future<? super Void>> var1);
     ......

    ChannelFuture sync() throws InterruptedException;
}
```

å¦å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ `ChannelFuture` æ¥å£çš„ `sync()`æ–¹æ³•è®©å¼‚æ­¥çš„æ“ä½œå˜æˆåŒæ­¥çš„ã€‚

#### 4.ChannelHandler å’Œ ChannelPipeline

ä¸‹é¢è¿™æ®µä»£ç ä½¿ç”¨è¿‡ Netty çš„å°ä¼™ä¼´åº”è¯¥ä¸ä¼šé™Œç”Ÿï¼Œæˆ‘ä»¬æŒ‡å®šäº†åºåˆ—åŒ–ç¼–è§£ç å™¨ä»¥åŠè‡ªå®šä¹‰çš„ `ChannelHandler` å¤„ç†æ¶ˆæ¯ã€‚

```java
        b.group(eventLoopGroup)
                .handler(new ChannelInitializer<SocketChannel>() {
                    @Override
                    protected void initChannel(SocketChannel ch) {
                        ch.pipeline().addLast(new NettyKryoDecoder(kryoSerializer, RpcResponse.class));
                        ch.pipeline().addLast(new NettyKryoEncoder(kryoSerializer, RpcRequest.class));
                        ch.pipeline().addLast(new KryoClientHandler());
                    }
                });
```

`ChannelHandler` æ˜¯æ¶ˆæ¯çš„å…·ä½“å¤„ç†å™¨ã€‚ä»–è´Ÿè´£å¤„ç†è¯»å†™æ“ä½œã€å®¢æˆ·ç«¯è¿æ¥ç­‰äº‹æƒ…ã€‚

`ChannelPipeline` ä¸º `ChannelHandler` çš„é“¾ï¼Œæä¾›äº†ä¸€ä¸ªå®¹å™¨å¹¶å®šä¹‰äº†ç”¨äºæ²¿ç€é“¾ä¼ æ’­å…¥ç«™å’Œå‡ºç«™äº‹ä»¶æµçš„ API ã€‚å½“ `Channel` è¢«åˆ›å»ºæ—¶ï¼Œå®ƒä¼šè¢«è‡ªåŠ¨åœ°åˆ†é…åˆ°å®ƒä¸“å±çš„ `ChannelPipeline`ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨ `ChannelPipeline` ä¸Šé€šè¿‡ `addLast()` æ–¹æ³•æ·»åŠ ä¸€ä¸ªæˆ–è€…å¤šä¸ª`ChannelHandler` ï¼Œå› ä¸ºä¸€ä¸ªæ•°æ®æˆ–è€…äº‹ä»¶å¯èƒ½ä¼šè¢«å¤šä¸ª Handler å¤„ç†ã€‚å½“ä¸€ä¸ª `ChannelHandler` å¤„ç†å®Œä¹‹åå°±å°†æ•°æ®äº¤ç»™ä¸‹ä¸€ä¸ª `ChannelHandler` ã€‚

### 5.4.5 EventloopGroup äº†è§£ä¹ˆ?å’Œ EventLoop å•¥å…³ç³»?

![](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/2020-8/2a5a4a71-cfb7-4735-bf5c-6a57007c82ec.png)

`EventLoopGroup` åŒ…å«å¤šä¸ª `EventLoop`ï¼ˆæ¯ä¸€ä¸ª `EventLoop` é€šå¸¸å†…éƒ¨åŒ…å«ä¸€ä¸ªçº¿ç¨‹ï¼‰ï¼Œä¸Šé¢æˆ‘ä»¬å·²ç»è¯´äº† `EventLoop` çš„ä¸»è¦ä½œç”¨å®é™…å°±æ˜¯è´Ÿè´£ç›‘å¬ç½‘ç»œäº‹ä»¶å¹¶è°ƒç”¨äº‹ä»¶å¤„ç†å™¨è¿›è¡Œç›¸å…³ I/O æ“ä½œçš„å¤„ç†ã€‚

å¹¶ä¸” `EventLoop` å¤„ç†çš„ I/O äº‹ä»¶éƒ½å°†åœ¨å®ƒä¸“æœ‰çš„ `Thread` ä¸Šè¢«å¤„ç†ï¼Œå³ `Thread` å’Œ `EventLoop` å±äº 1 : 1 çš„å…³ç³»ï¼Œä»è€Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

ä¸Šå›¾æ˜¯ä¸€ä¸ªæœåŠ¡ç«¯å¯¹ `EventLoopGroup` ä½¿ç”¨çš„å¤§è‡´æ¨¡å—å›¾ï¼Œå…¶ä¸­ `Boss EventloopGroup` ç”¨äºæ¥æ”¶è¿æ¥ï¼Œ`Worker EventloopGroup` ç”¨äºå…·ä½“çš„å¤„ç†ï¼ˆæ¶ˆæ¯çš„è¯»å†™ä»¥åŠå…¶ä»–é€»è¾‘å¤„ç†ï¼‰ã€‚

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼š å½“å®¢æˆ·ç«¯é€šè¿‡ `connect` æ–¹æ³•è¿æ¥æœåŠ¡ç«¯æ—¶ï¼Œ`bossGroup` å¤„ç†å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ã€‚å½“å®¢æˆ·ç«¯å¤„ç†å®Œæˆåï¼Œä¼šå°†è¿™ä¸ªè¿æ¥æäº¤ç»™ `workerGroup` æ¥å¤„ç†ï¼Œç„¶å `workerGroup` è´Ÿè´£å¤„ç†å…¶ IO ç›¸å…³æ“ä½œã€‚

### 5.4.6 Bootstrap å’Œ ServerBootstrap äº†è§£ä¹ˆï¼Ÿ

`Bootstrap` æ˜¯å®¢æˆ·ç«¯çš„å¯åŠ¨å¼•å¯¼ç±»/è¾…åŠ©ç±»ï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

```java
        EventLoopGroup group = new NioEventLoopGroup();
        try {
            //åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šBootstrap
            Bootstrap b = new Bootstrap();
            //æŒ‡å®šçº¿ç¨‹æ¨¡å‹
            b.group(group).
                    ......
            // å°è¯•å»ºç«‹è¿æ¥
            ChannelFuture f = b.connect(host, port).sync();
            f.channel().closeFuture().sync();
        } finally {
            // ä¼˜é›…å…³é—­ç›¸å…³çº¿ç¨‹ç»„èµ„æº
            group.shutdownGracefully();
        }
```

`ServerBootstrap` æœåŠ¡ç«¯çš„å¯åŠ¨å¼•å¯¼ç±»/è¾…åŠ©ç±»ï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

```java
        // 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
        EventLoopGroup bossGroup = new NioEventLoopGroup(1);
        EventLoopGroup workerGroup = new NioEventLoopGroup();
        try {
            //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
            ServerBootstrap b = new ServerBootstrap();
            //3.ç»™å¼•å¯¼ç±»é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„,ç¡®å®šäº†çº¿ç¨‹æ¨¡å‹
            b.group(bossGroup, workerGroup).
                   ......
            // 6.ç»‘å®šç«¯å£
            ChannelFuture f = b.bind(port).sync();
            // ç­‰å¾…è¿æ¥å…³é—­
            f.channel().closeFuture().sync();
        } finally {
            //7.ä¼˜é›…å…³é—­ç›¸å…³çº¿ç¨‹ç»„èµ„æº
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
```

ä»ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š

1. `Bootstrap` é€šå¸¸ä½¿ç”¨ `connet()` æ–¹æ³•è¿æ¥åˆ°è¿œç¨‹çš„ä¸»æœºå’Œç«¯å£ï¼Œä½œä¸ºä¸€ä¸ª Netty TCP åè®®é€šä¿¡ä¸­çš„å®¢æˆ·ç«¯ã€‚å¦å¤–ï¼Œ`Bootstrap` ä¹Ÿå¯ä»¥é€šè¿‡ `bind()` æ–¹æ³•ç»‘å®šæœ¬åœ°çš„ä¸€ä¸ªç«¯å£ï¼Œä½œä¸º UDP åè®®é€šä¿¡ä¸­çš„ä¸€ç«¯ã€‚
2. `ServerBootstrap`é€šå¸¸ä½¿ç”¨ `bind()` æ–¹æ³•ç»‘å®šæœ¬åœ°çš„ç«¯å£ä¸Šï¼Œç„¶åç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ã€‚
3. `Bootstrap` åªéœ€è¦é…ç½®ä¸€ä¸ªçº¿ç¨‹ç»„â€” `EventLoopGroup` ,è€Œ `ServerBootstrap`éœ€è¦é…ç½®ä¸¤ä¸ªçº¿ç¨‹ç»„â€” `EventLoopGroup` ï¼Œä¸€ä¸ªç”¨äºæ¥æ”¶è¿æ¥ï¼Œä¸€ä¸ªç”¨äºå…·ä½“çš„å¤„ç†ã€‚

### 5.4.7 NioEventLoopGroup é»˜è®¤çš„æ„é€ å‡½æ•°ä¼šèµ·å¤šå°‘çº¿ç¨‹ï¼Ÿ

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šçœ‹è¿‡ Netty çš„æºç äº†ä¹ˆï¼Ÿ`NioEventLoopGroup` é»˜è®¤çš„æ„é€ å‡½æ•°ä¼šèµ·å¤šå°‘çº¿ç¨‹å‘¢ï¼Ÿ

ğŸ™‹ **æˆ‘** ï¼šå—¯å—¯ï¼çœ‹è¿‡éƒ¨åˆ†ã€‚

å›é¡¾æˆ‘ä»¬åœ¨ä¸Šé¢å†™çš„æœåŠ¡å™¨ç«¯çš„ä»£ç ï¼š

```java
// 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
EventLoopGroup bossGroup = new NioEventLoopGroup(1);
EventLoopGroup workerGroup = new NioEventLoopGroup();
```

ä¸ºäº†ææ¸…æ¥š`NioEventLoopGroup` é»˜è®¤çš„æ„é€ å‡½æ•° åˆ°åº•åˆ›å»ºäº†å¤šå°‘ä¸ªçº¿ç¨‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„æºç ã€‚

```java
    /**
     * æ— å‚æ„é€ å‡½æ•°ã€‚
     * nThreads:0
     */
    public NioEventLoopGroup() {
        //è°ƒç”¨ä¸‹ä¸€ä¸ªæ„é€ æ–¹æ³•
        this(0);
    }

    /**
     * Executorï¼šnull
     */
    public NioEventLoopGroup(int nThreads) {
        //ç»§ç»­è°ƒç”¨ä¸‹ä¸€ä¸ªæ„é€ æ–¹æ³•
        this(nThreads, (Executor) null);
    }

    //ä¸­é—´çœç•¥éƒ¨åˆ†æ„é€ å‡½æ•°

    /**
     * RejectedExecutionHandlerï¼ˆï¼‰ï¼šRejectedExecutionHandlers.reject()
     */
    public NioEventLoopGroup(int nThreads, Executor executor, final SelectorProvider selectorProvider,final SelectStrategyFactory selectStrategyFactory) {
       //å¼€å§‹è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°
        super(nThreads, executor, selectorProvider, selectStrategyFactory, RejectedExecutionHandlers.reject());
    }

```

ä¸€ç›´å‘ä¸‹èµ°ä¸‹å»çš„è¯ï¼Œä½ ä¼šå‘ç°åœ¨ `MultithreadEventLoopGroup` ç±»ä¸­æœ‰ç›¸å…³çš„æŒ‡å®šçº¿ç¨‹æ•°çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š

```java
    // ä»1ï¼Œç³»ç»Ÿå±æ€§ï¼ŒCPUæ ¸å¿ƒæ•°*2 è¿™ä¸‰ä¸ªå€¼ä¸­å–å‡ºä¸€ä¸ªæœ€å¤§çš„
    //å¯ä»¥å¾—å‡º DEFAULT_EVENT_LOOP_THREADS çš„å€¼ä¸ºCPUæ ¸å¿ƒæ•°*2
    private static final int DEFAULT_EVENT_LOOP_THREADS = Math.max(1, SystemPropertyUtil.getInt("io.netty.eventLoopThreads", NettyRuntime.availableProcessors() * 2));

    // è¢«è°ƒç”¨çš„çˆ¶ç±»æ„é€ å‡½æ•°ï¼ŒNioEventLoopGroup é»˜è®¤çš„æ„é€ å‡½æ•°ä¼šèµ·å¤šå°‘çº¿ç¨‹çš„ç§˜å¯†æ‰€åœ¨
    // å½“æŒ‡å®šçš„çº¿ç¨‹æ•°nThreadsä¸º0æ—¶ï¼Œä½¿ç”¨é»˜è®¤çš„çº¿ç¨‹æ•°DEFAULT_EVENT_LOOP_THREADS
    protected MultithreadEventLoopGroup(int nThreads, ThreadFactory threadFactory, Object... args) {
        super(nThreads == 0 ? DEFAULT_EVENT_LOOP_THREADS : nThreads, threadFactory, args);
    }
```

ç»¼ä¸Šï¼Œæˆ‘ä»¬å‘ç° `NioEventLoopGroup` é»˜è®¤çš„æ„é€ å‡½æ•°å®é™…ä¼šèµ·çš„çº¿ç¨‹æ•°ä¸º **`CPUæ ¸å¿ƒæ•°*2`**ã€‚

å¦å¤–ï¼Œå¦‚æœä½ ç»§ç»­æ·±å…¥ä¸‹å»çœ‹æ„é€ å‡½æ•°çš„è¯ï¼Œä½ ä¼šå‘ç°æ¯ä¸ª`NioEventLoopGroup`å¯¹è±¡å†…éƒ¨éƒ½ä¼šåˆ†é…ä¸€ç»„`NioEventLoop`ï¼Œå…¶å¤§å°æ˜¯ `nThreads`, è¿™æ ·å°±æ„æˆäº†ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œ ä¸€ä¸ª`NIOEventLoop` å’Œä¸€ä¸ªçº¿ç¨‹ç›¸å¯¹åº”ï¼Œè¿™å’Œæˆ‘ä»¬ä¸Šé¢è¯´çš„ `EventloopGroup` å’Œ `EventLoop`å…³ç³»è¿™éƒ¨åˆ†å†…å®¹ç›¸å¯¹åº”ã€‚

### 5.4.8 Netty çº¿ç¨‹æ¨¡å‹äº†è§£ä¹ˆï¼Ÿ

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šè¯´ä¸€ä¸‹ Netty çº¿ç¨‹æ¨¡å‹å§ï¼

ğŸ™‹ **æˆ‘** ï¼šå¤§éƒ¨åˆ†ç½‘ç»œæ¡†æ¶éƒ½æ˜¯åŸºäº Reactor æ¨¡å¼è®¾è®¡å¼€å‘çš„ã€‚

> Reactor æ¨¡å¼åŸºäºäº‹ä»¶é©±åŠ¨ï¼Œé‡‡ç”¨å¤šè·¯å¤ç”¨å°†äº‹ä»¶åˆ†å‘ç»™ç›¸åº”çš„ Handler å¤„ç†ï¼Œéå¸¸é€‚åˆå¤„ç†æµ·é‡ IO çš„åœºæ™¯ã€‚

åœ¨ Netty ä¸»è¦é  `NioEventLoopGroup` çº¿ç¨‹æ± æ¥å®ç°å…·ä½“çš„çº¿ç¨‹æ¨¡å‹çš„ ã€‚

æˆ‘ä»¬å®ç°æœåŠ¡ç«¯çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šåˆå§‹åŒ–ä¸¤ä¸ªçº¿ç¨‹ç»„ï¼š

1. **`bossGroup`** :æ¥æ”¶è¿æ¥ã€‚
2. **`workerGroup`** ï¼šè´Ÿè´£å…·ä½“çš„å¤„ç†ï¼Œäº¤ç”±å¯¹åº”çš„ Handler å¤„ç†ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸€ä¸‹ Netty ä¸­çš„çº¿ç¨‹æ¨¡å‹å§ï¼

1.**å•çº¿ç¨‹æ¨¡å‹** ï¼š

ä¸€ä¸ªçº¿ç¨‹éœ€è¦æ‰§è¡Œå¤„ç†æ‰€æœ‰çš„ `accept`ã€`read`ã€`decode`ã€`process`ã€`encode`ã€`send` äº‹ä»¶ã€‚å¯¹äºé«˜è´Ÿè½½ã€é«˜å¹¶å‘ï¼Œå¹¶ä¸”å¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯ä¸é€‚ç”¨ã€‚

å¯¹åº”åˆ° Netty ä»£ç æ˜¯ä¸‹é¢è¿™æ ·çš„

> ä½¿ç”¨ `NioEventLoopGroup` ç±»çš„æ— å‚æ„é€ å‡½æ•°è®¾ç½®çº¿ç¨‹æ•°é‡çš„é»˜è®¤å€¼å°±æ˜¯ **CPU æ ¸å¿ƒæ•° \*2** ã€‚

```java
  //1.eventGroupæ—¢ç”¨äºå¤„ç†å®¢æˆ·ç«¯è¿æ¥ï¼Œåˆè´Ÿè´£å…·ä½“çš„å¤„ç†ã€‚
  EventLoopGroup eventGroup = new NioEventLoopGroup(1);
  //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
  ServerBootstrap b = new ServerBootstrap();
            boobtstrap.group(eventGroup, eventGroup)
            //......
```

2.**å¤šçº¿ç¨‹æ¨¡å‹**

ä¸€ä¸ª Acceptor çº¿ç¨‹åªè´Ÿè´£ç›‘å¬å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œä¸€ä¸ª NIO çº¿ç¨‹æ± è´Ÿè´£å…·ä½“å¤„ç†ï¼š `accept`ã€`read`ã€`decode`ã€`process`ã€`encode`ã€`send` äº‹ä»¶ã€‚æ»¡è¶³ç»å¤§éƒ¨åˆ†åº”ç”¨åœºæ™¯ï¼Œå¹¶å‘è¿æ¥é‡ä¸å¤§çš„æ—¶å€™æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯é‡åˆ°å¹¶å‘è¿æ¥å¤§çš„æ—¶å€™å°±å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚

å¯¹åº”åˆ° Netty ä»£ç æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

```java
// 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
EventLoopGroup bossGroup = new NioEventLoopGroup(1);
EventLoopGroup workerGroup = new NioEventLoopGroup();
try {
  //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
  ServerBootstrap b = new ServerBootstrap();
  //3.ç»™å¼•å¯¼ç±»é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„,ç¡®å®šäº†çº¿ç¨‹æ¨¡å‹
  b.group(bossGroup, workerGroup)
    //......
```

![](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/2020-8/7e7357ef-e724-4122-847c-fbccd9eb6ae3.png)

**3.ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹**

ä»ä¸€ä¸ª ä¸»çº¿ç¨‹ NIO çº¿ç¨‹æ± ä¸­é€‰æ‹©ä¸€ä¸ªçº¿ç¨‹ä½œä¸º Acceptor çº¿ç¨‹ï¼Œç»‘å®šç›‘å¬ç«¯å£ï¼Œæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„è¿æ¥ï¼Œå…¶ä»–çº¿ç¨‹è´Ÿè´£åç»­çš„æ¥å…¥è®¤è¯ç­‰å·¥ä½œã€‚è¿æ¥å»ºç«‹å®Œæˆåï¼ŒSub NIO çº¿ç¨‹æ± è´Ÿè´£å…·ä½“å¤„ç† I/O è¯»å†™ã€‚å¦‚æœå¤šçº¿ç¨‹æ¨¡å‹æ— æ³•æ»¡è¶³ä½ çš„éœ€æ±‚çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹ ã€‚

```java
// 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
EventLoopGroup bossGroup = new NioEventLoopGroup();
EventLoopGroup workerGroup = new NioEventLoopGroup();
try {
  //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
  ServerBootstrap b = new ServerBootstrap();
  //3.ç»™å¼•å¯¼ç±»é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„,ç¡®å®šäº†çº¿ç¨‹æ¨¡å‹
  b.group(bossGroup, workerGroup)
    //......
```

![](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/2020-8/04d0a911-a5c1-4c18-947e-d14b80634510.png)

### 5.4.9 Netty æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å¯åŠ¨è¿‡ç¨‹äº†è§£ä¹ˆï¼Ÿ

#### æœåŠ¡ç«¯

```java
        // 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
        EventLoopGroup bossGroup = new NioEventLoopGroup(1);
        EventLoopGroup workerGroup = new NioEventLoopGroup();
        try {
            //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
            ServerBootstrap b = new ServerBootstrap();
            //3.ç»™å¼•å¯¼ç±»é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„,ç¡®å®šäº†çº¿ç¨‹æ¨¡å‹
            b.group(bossGroup, workerGroup)
                    // (éå¿…å¤‡)æ‰“å°æ—¥å¿—
                    .handler(new LoggingHandler(LogLevel.INFO))
                    // 4.æŒ‡å®š IO æ¨¡å‹
                    .channel(NioServerSocketChannel.class)
                    .childHandler(new ChannelInitializer<SocketChannel>() {
                        @Override
                        public void initChannel(SocketChannel ch) {
                            ChannelPipeline p = ch.pipeline();
                            //5.å¯ä»¥è‡ªå®šä¹‰å®¢æˆ·ç«¯æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
                            p.addLast(new HelloServerHandler());
                        }
                    });
            // 6.ç»‘å®šç«¯å£,è°ƒç”¨ sync æ–¹æ³•é˜»å¡çŸ¥é“ç»‘å®šå®Œæˆ
            ChannelFuture f = b.bind(port).sync();
            // 7.é˜»å¡ç­‰å¾…ç›´åˆ°æœåŠ¡å™¨Channelå…³é—­(closeFuture()æ–¹æ³•è·å–Channel çš„CloseFutureå¯¹è±¡,ç„¶åè°ƒç”¨sync()æ–¹æ³•)
            f.channel().closeFuture().sync();
        } finally {
            //8.ä¼˜é›…å…³é—­ç›¸å…³çº¿ç¨‹ç»„èµ„æº
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
```

ç®€å•è§£æä¸€ä¸‹æœåŠ¡ç«¯çš„åˆ›å»ºè¿‡ç¨‹å…·ä½“æ˜¯æ€æ ·çš„ï¼š

1.é¦–å…ˆä½ åˆ›å»ºäº†ä¸¤ä¸ª `NioEventLoopGroup` å¯¹è±¡å®ä¾‹ï¼š`bossGroup` å’Œ `workerGroup`ã€‚

- `bossGroup` : ç”¨äºå¤„ç†å®¢æˆ·ç«¯çš„ TCP è¿æ¥è¯·æ±‚ã€‚
- `workerGroup` ï¼š è´Ÿè´£æ¯ä¸€æ¡è¿æ¥çš„å…·ä½“è¯»å†™æ•°æ®çš„å¤„ç†é€»è¾‘ï¼ŒçœŸæ­£è´Ÿè´£ I/O è¯»å†™æ“ä½œï¼Œäº¤ç”±å¯¹åº”çš„ Handler å¤„ç†ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬æŠŠå…¬å¸çš„è€æ¿å½“åš bossGroupï¼Œå‘˜å·¥å½“åš workerGroupï¼ŒbossGroup åœ¨å¤–é¢æ¥å®Œæ´»ä¹‹åï¼Œæ‰”ç»™ workerGroup å»å¤„ç†ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šæŒ‡å®š bossGroup çš„ çº¿ç¨‹æ•°ä¸º 1ï¼ˆå¹¶å‘è¿æ¥é‡ä¸å¤§çš„æ—¶å€™ï¼‰ ï¼ŒworkGroup çš„çº¿ç¨‹æ•°é‡ä¸º **CPU æ ¸å¿ƒæ•° \*2** ã€‚å¦å¤–ï¼Œæ ¹æ®æºç æ¥çœ‹ï¼Œä½¿ç”¨ `NioEventLoopGroup` ç±»çš„æ— å‚æ„é€ å‡½æ•°è®¾ç½®çº¿ç¨‹æ•°é‡çš„é»˜è®¤å€¼å°±æ˜¯ **CPU æ ¸å¿ƒæ•° \*2** ã€‚

2.æ¥ä¸‹æ¥ æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼š `ServerBootstrap`ï¼Œè¿™ä¸ªç±»å°†å¼•å¯¼æˆ‘ä»¬è¿›è¡ŒæœåŠ¡ç«¯çš„å¯åŠ¨å·¥ä½œã€‚

3.é€šè¿‡ `.group()` æ–¹æ³•ç»™å¼•å¯¼ç±» `ServerBootstrap` é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„ï¼Œç¡®å®šäº†çº¿ç¨‹æ¨¡å‹ã€‚

é€šè¿‡ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬å®é™…é…ç½®çš„æ˜¯å¤šçº¿ç¨‹æ¨¡å‹ï¼Œè¿™ä¸ªåœ¨ä¸Šé¢æåˆ°è¿‡ã€‚

```java
    EventLoopGroup bossGroup = new NioEventLoopGroup(1);
    EventLoopGroup workerGroup = new NioEventLoopGroup();
```

4.é€šè¿‡`channel()`æ–¹æ³•ç»™å¼•å¯¼ç±» `ServerBootstrap`æŒ‡å®šäº† IO æ¨¡å‹ä¸º`NIO`

- `NioServerSocketChannel` ï¼šæŒ‡å®šæœåŠ¡ç«¯çš„ IO æ¨¡å‹ä¸º NIOï¼Œä¸ BIO ç¼–ç¨‹æ¨¡å‹ä¸­çš„`ServerSocket`å¯¹åº”
- `NioSocketChannel` : æŒ‡å®šå®¢æˆ·ç«¯çš„ IO æ¨¡å‹ä¸º NIOï¼Œ ä¸ BIO ç¼–ç¨‹æ¨¡å‹ä¸­çš„`Socket`å¯¹åº”

  5.é€šè¿‡ `.childHandler()`ç»™å¼•å¯¼ç±»åˆ›å»ºä¸€ä¸ª`ChannelInitializer` ï¼Œç„¶åæŒ‡å®šäº†æœåŠ¡ç«¯æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘ `HelloServerHandler` å¯¹è±¡

  6.è°ƒç”¨ `ServerBootstrap` ç±»çš„ `bind()`æ–¹æ³•ç»‘å®šç«¯å£

#### å®¢æˆ·ç«¯

```java
        //1.åˆ›å»ºä¸€ä¸ª NioEventLoopGroup å¯¹è±¡å®ä¾‹
        EventLoopGroup group = new NioEventLoopGroup();
        try {
            //2.åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šBootstrap
            Bootstrap b = new Bootstrap();
            //3.æŒ‡å®šçº¿ç¨‹ç»„
            b.group(group)
                    //4.æŒ‡å®š IO æ¨¡å‹
                    .channel(NioSocketChannel.class)
                    .handler(new ChannelInitializer<SocketChannel>() {
                        @Override
                        public void initChannel(SocketChannel ch) throws Exception {
                            ChannelPipeline p = ch.pipeline();
                            // 5.è¿™é‡Œå¯ä»¥è‡ªå®šä¹‰æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
                            p.addLast(new HelloClientHandler(message));
                        }
                    });
            // 6.å°è¯•å»ºç«‹è¿æ¥
            ChannelFuture f = b.connect(host, port).sync();
            // 7.ç­‰å¾…è¿æ¥å…³é—­ï¼ˆé˜»å¡ï¼Œç›´åˆ°Channelå…³é—­ï¼‰
            f.channel().closeFuture().sync();
        } finally {
            group.shutdownGracefully();
        }
```

ç»§ç»­åˆ†æä¸€ä¸‹å®¢æˆ·ç«¯çš„åˆ›å»ºæµç¨‹ï¼š

1.åˆ›å»ºä¸€ä¸ª `NioEventLoopGroup` å¯¹è±¡å®ä¾‹

2.åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨çš„å¼•å¯¼ç±»æ˜¯ `Bootstrap`

3.é€šè¿‡ `.group()` æ–¹æ³•ç»™å¼•å¯¼ç±» `Bootstrap` é…ç½®ä¸€ä¸ªçº¿ç¨‹ç»„

4.é€šè¿‡`channel()`æ–¹æ³•ç»™å¼•å¯¼ç±» `Bootstrap`æŒ‡å®šäº† IO æ¨¡å‹ä¸º`NIO`

5.é€šè¿‡ `.childHandler()`ç»™å¼•å¯¼ç±»åˆ›å»ºä¸€ä¸ª`ChannelInitializer` ï¼Œç„¶åæŒ‡å®šäº†å®¢æˆ·ç«¯æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘ `HelloClientHandler` å¯¹è±¡

6.è°ƒç”¨ `Bootstrap` ç±»çš„ `connect()`æ–¹æ³•è¿›è¡Œè¿æ¥ï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦æŒ‡å®šä¸¤ä¸ªå‚æ•°ï¼š

- `inetHost` : ip åœ°å€
- `inetPort` : ç«¯å£å·

```java
    public ChannelFuture connect(String inetHost, int inetPort) {
        return this.connect(InetSocketAddress.createUnresolved(inetHost, inetPort));
    }
    public ChannelFuture connect(SocketAddress remoteAddress) {
        ObjectUtil.checkNotNull(remoteAddress, "remoteAddress");
        this.validate();
        return this.doResolveAndConnect(remoteAddress, this.config.localAddress());
    }
```

`connect` æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª `Future` ç±»å‹çš„å¯¹è±¡

```java
public interface ChannelFuture extends Future<Void> {
  ......
}
```

ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ–¹æ˜¯å¼‚æ­¥çš„ï¼Œæˆ‘ä»¬é€šè¿‡ `addListener` æ–¹æ³•å¯ä»¥ç›‘å¬åˆ°è¿æ¥æ˜¯å¦æˆåŠŸï¼Œè¿›è€Œæ‰“å°å‡ºè¿æ¥ä¿¡æ¯ã€‚å…·ä½“åšæ³•å¾ˆç®€å•ï¼Œåªéœ€è¦å¯¹ä»£ç è¿›è¡Œä»¥ä¸‹æ”¹åŠ¨ï¼š

```java
ChannelFuture f = b.connect(host, port).addListener(future -> {
  if (future.isSuccess()) {
    System.out.println("è¿æ¥æˆåŠŸ!");
  } else {
    System.err.println("è¿æ¥å¤±è´¥!");
  }
}).sync();
```

### 5.4.10 ä»€ä¹ˆæ˜¯ TCP ç²˜åŒ…/æ‹†åŒ…?æœ‰ä»€ä¹ˆè§£å†³åŠæ³•å‘¢ï¼Ÿ

TCP ç²˜åŒ…/æ‹†åŒ… å°±æ˜¯ä½ åŸºäº TCP å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå‡ºç°äº†å¤šä¸ªå­—ç¬¦ä¸²â€œç²˜â€åœ¨äº†ä¸€èµ·æˆ–è€…ä¸€ä¸ªå­—ç¬¦ä¸²è¢«â€œæ‹†â€å¼€çš„é—®é¢˜ã€‚æ¯”å¦‚ä½ å¤šæ¬¡å‘é€ï¼šâ€œä½ å¥½,ä½ çœŸå¸…å•Šï¼å“¥å“¥ï¼â€ï¼Œä½†æ˜¯å®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„å¯èƒ½æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

![](https://guide-blog-images.oss-cn-shenzhen.aliyuncs.com/2020-8/07bd8979-2b34-4000-a829-03a74d0701b2-20200802233754778.png)

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šé‚£æœ‰ä»€ä¹ˆè§£å†³åŠæ³•å‘¢?

ğŸ™‹ **æˆ‘** ï¼š

**1.ä½¿ç”¨ Netty è‡ªå¸¦çš„è§£ç å™¨**

- **`LineBasedFrameDecoder`** : å‘é€ç«¯å‘é€æ•°æ®åŒ…çš„æ—¶å€™ï¼Œæ¯ä¸ªæ•°æ®åŒ…ä¹‹é—´ä»¥æ¢è¡Œç¬¦ä½œä¸ºåˆ†éš”ï¼Œ`LineBasedFrameDecoder` çš„å·¥ä½œåŸç†æ˜¯å®ƒä¾æ¬¡éå† `ByteBuf` ä¸­çš„å¯è¯»å­—èŠ‚ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ¢è¡Œç¬¦ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„æˆªå–ã€‚
- **`DelimiterBasedFrameDecoder`** : å¯ä»¥è‡ªå®šä¹‰åˆ†éš”ç¬¦è§£ç å™¨ï¼Œ**`LineBasedFrameDecoder`** å®é™…ä¸Šæ˜¯ä¸€ç§ç‰¹æ®Šçš„ `DelimiterBasedFrameDecoder` è§£ç å™¨ã€‚
- **`FixedLengthFrameDecoder`**: å›ºå®šé•¿åº¦è§£ç å™¨ï¼Œå®ƒèƒ½å¤ŸæŒ‰ç…§æŒ‡å®šçš„é•¿åº¦å¯¹æ¶ˆæ¯è¿›è¡Œç›¸åº”çš„æ‹†åŒ…ã€‚
- **`LengthFieldBasedFrameDecoder`**ï¼š

**2.è‡ªå®šä¹‰åºåˆ—åŒ–ç¼–è§£ç å™¨**

åœ¨ Java ä¸­è‡ªå¸¦çš„æœ‰å®ç° `Serializable` æ¥å£æ¥å®ç°åºåˆ—åŒ–ï¼Œä½†ç”±äºå®ƒæ€§èƒ½ã€å®‰å…¨æ€§ç­‰åŸå› ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸ä¼šè¢«ä½¿ç”¨åˆ°çš„ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ Protostuffã€Hessian2ã€json åºåˆ—æ–¹å¼æ¯”è¾ƒå¤šï¼Œå¦å¤–è¿˜æœ‰ä¸€äº›åºåˆ—åŒ–æ€§èƒ½éå¸¸å¥½çš„åºåˆ—åŒ–æ–¹å¼ä¹Ÿæ˜¯å¾ˆå¥½çš„é€‰æ‹©ï¼š

- ä¸“é—¨é’ˆå¯¹ Java è¯­è¨€çš„ï¼šKryoï¼ŒFST ç­‰ç­‰
- è·¨è¯­è¨€çš„ï¼šProtostuffï¼ˆåŸºäº protobuf å‘å±•è€Œæ¥ï¼‰ï¼ŒProtoBufï¼ŒThriftï¼ŒAvroï¼ŒMsgPack ç­‰ç­‰

> ç”±äºç¯‡å¹…é—®é¢˜ï¼Œè¿™éƒ¨åˆ†å†…å®¹ä¼šåœ¨åç»­çš„æ–‡ç« ä¸­è¯¦ç»†åˆ†æä»‹ç»~~~

### 5.4.11 Netty é•¿è¿æ¥ã€å¿ƒè·³æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šTCP é•¿è¿æ¥å’ŒçŸ­è¿æ¥äº†è§£ä¹ˆï¼Ÿ

ğŸ™‹ **æˆ‘** ï¼šæˆ‘ä»¬çŸ¥é“ TCP åœ¨è¿›è¡Œè¯»å†™ä¹‹å‰ï¼Œserver ä¸ client ä¹‹é—´å¿…é¡»æå‰å»ºç«‹ä¸€ä¸ªè¿æ¥ã€‚å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ï¼Œéœ€è¦æˆ‘ä»¬å¸¸è¯´çš„ä¸‰æ¬¡æ¡æ‰‹ï¼Œé‡Šæ”¾/å…³é—­è¿æ¥çš„è¯éœ€è¦å››æ¬¡æŒ¥æ‰‹ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯æ¯”è¾ƒæ¶ˆè€—ç½‘ç»œèµ„æºå¹¶ä¸”æœ‰æ—¶é—´å»¶è¿Ÿçš„ã€‚

æ‰€è°“ï¼ŒçŸ­è¿æ¥è¯´çš„å°±æ˜¯ server ç«¯ ä¸ client ç«¯å»ºç«‹è¿æ¥ä¹‹åï¼Œè¯»å†™å®Œæˆä¹‹åå°±å…³é—­æ‰è¿æ¥ï¼Œå¦‚æœä¸‹ä¸€æ¬¡å†è¦äº’ç›¸å‘é€æ¶ˆæ¯ï¼Œå°±è¦é‡æ–°è¿æ¥ã€‚çŸ­è¿æ¥çš„ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯ç®¡ç†å’Œå®ç°éƒ½æ¯”è¾ƒç®€å•ï¼Œç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œæ¯ä¸€æ¬¡çš„è¯»å†™éƒ½è¦å»ºç«‹è¿æ¥å¿…ç„¶ä¼šå¸¦æ¥å¤§é‡ç½‘ç»œèµ„æºçš„æ¶ˆè€—ï¼Œå¹¶ä¸”è¿æ¥çš„å»ºç«‹ä¹Ÿéœ€è¦è€—è´¹æ—¶é—´ã€‚

é•¿è¿æ¥è¯´çš„å°±æ˜¯ client å‘ server åŒæ–¹å»ºç«‹è¿æ¥ä¹‹åï¼Œå³ä½¿ client ä¸ server å®Œæˆä¸€æ¬¡è¯»å†™ï¼Œå®ƒä»¬ä¹‹é—´çš„è¿æ¥å¹¶ä¸ä¼šä¸»åŠ¨å…³é—­ï¼Œåç»­çš„è¯»å†™æ“ä½œä¼šç»§ç»­ä½¿ç”¨è¿™ä¸ªè¿æ¥ã€‚é•¿è¿æ¥çš„å¯ä»¥çœå»è¾ƒå¤šçš„ TCP å»ºç«‹å’Œå…³é—­çš„æ“ä½œï¼Œé™ä½å¯¹ç½‘ç»œèµ„æºçš„ä¾èµ–ï¼ŒèŠ‚çº¦æ—¶é—´ã€‚å¯¹äºé¢‘ç¹è¯·æ±‚èµ„æºçš„å®¢æˆ·æ¥è¯´ï¼Œéå¸¸é€‚ç”¨é•¿è¿æ¥ã€‚

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³æœºåˆ¶ï¼ŸNetty ä¸­å¿ƒè·³æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ

ğŸ™‹ **æˆ‘** ï¼š

åœ¨ TCP ä¿æŒé•¿è¿æ¥çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°æ–­ç½‘ç­‰ç½‘ç»œå¼‚å¸¸å‡ºç°ï¼Œå¼‚å¸¸å‘ç”Ÿçš„æ—¶å€™ï¼Œ client ä¸ server ä¹‹é—´å¦‚æœæ²¡æœ‰äº¤äº’çš„è¯ï¼Œå®ƒä»¬æ˜¯æ— æ³•å‘ç°å¯¹æ–¹å·²ç»æ‰çº¿çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜, æˆ‘ä»¬å°±éœ€è¦å¼•å…¥ **å¿ƒè·³æœºåˆ¶** ã€‚

å¿ƒè·³æœºåˆ¶çš„å·¥ä½œåŸç†æ˜¯: åœ¨ client ä¸ server ä¹‹é—´åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ•°æ®äº¤äº’æ—¶, å³å¤„äº idle çŠ¶æ€æ—¶, å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨å°±ä¼šå‘é€ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®åŒ…ç»™å¯¹æ–¹, å½“æ¥æ”¶æ–¹æ”¶åˆ°è¿™ä¸ªæ•°æ®æŠ¥æ–‡å, ä¹Ÿç«‹å³å‘é€ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®æŠ¥æ–‡, å›åº”å‘é€æ–¹, æ­¤å³ä¸€ä¸ª PING-PONG äº¤äº’ã€‚æ‰€ä»¥, å½“æŸä¸€ç«¯æ”¶åˆ°å¿ƒè·³æ¶ˆæ¯å, å°±çŸ¥é“äº†å¯¹æ–¹ä»ç„¶åœ¨çº¿, è¿™å°±ç¡®ä¿ TCP è¿æ¥çš„æœ‰æ•ˆæ€§.

TCP å®é™…ä¸Šè‡ªå¸¦çš„å°±æœ‰é•¿è¿æ¥é€‰é¡¹ï¼Œæœ¬èº«æ˜¯ä¹Ÿæœ‰å¿ƒè·³åŒ…æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ TCP çš„é€‰é¡¹ï¼š`SO_KEEPALIVE`ã€‚ ä½†æ˜¯ï¼ŒTCP åè®®å±‚é¢çš„é•¿è¿æ¥çµæ´»æ€§ä¸å¤Ÿã€‚æ‰€ä»¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æ˜¯åœ¨åº”ç”¨å±‚åè®®ä¸Šå®ç°è‡ªå®šä¹‰å¿ƒè·³æœºåˆ¶çš„ï¼Œä¹Ÿå°±æ˜¯åœ¨ Netty å±‚é¢é€šè¿‡ç¼–ç å®ç°ã€‚é€šè¿‡ Netty å®ç°å¿ƒè·³æœºåˆ¶çš„è¯ï¼Œæ ¸å¿ƒç±»æ˜¯ `IdleStateHandler` ã€‚

### 5.4.12 Netty çš„é›¶æ‹·è´äº†è§£ä¹ˆï¼Ÿ

ç»´åŸºç™¾ç§‘æ˜¯è¿™æ ·ä»‹ç»é›¶æ‹·è´çš„ï¼š

> é›¶å¤åˆ¶ï¼ˆè‹±è¯­ï¼šZero-copyï¼›ä¹Ÿè¯‘é›¶æ‹·è´ï¼‰æŠ€æœ¯æ˜¯æŒ‡è®¡ç®—æœºæ‰§è¡Œæ“ä½œæ—¶ï¼ŒCPU ä¸éœ€è¦å…ˆå°†æ•°æ®ä»æŸå¤„å†…å­˜å¤åˆ¶åˆ°å¦ä¸€ä¸ªç‰¹å®šåŒºåŸŸã€‚è¿™ç§æŠ€æœ¯é€šå¸¸ç”¨äºé€šè¿‡ç½‘ç»œä¼ è¾“æ–‡ä»¶æ—¶èŠ‚çœ CPU å‘¨æœŸå’Œå†…å­˜å¸¦å®½ã€‚

åœ¨ OS å±‚é¢ä¸Šçš„ `Zero-copy` é€šå¸¸æŒ‡é¿å…åœ¨ `ç”¨æˆ·æ€(User-space)` ä¸ `å†…æ ¸æ€(Kernel-space)` ä¹‹é—´æ¥å›æ‹·è´æ•°æ®ã€‚è€Œåœ¨ Netty å±‚é¢ ï¼Œé›¶æ‹·è´ä¸»è¦ä½“ç°åœ¨å¯¹äºæ•°æ®æ“ä½œçš„ä¼˜åŒ–ã€‚

Netty ä¸­çš„é›¶æ‹·è´ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢

1. ä½¿ç”¨ Netty æä¾›çš„ `CompositeByteBuf` ç±», å¯ä»¥å°†å¤šä¸ª`ByteBuf` åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ `ByteBuf`, é¿å…äº†å„ä¸ª `ByteBuf` ä¹‹é—´çš„æ‹·è´ã€‚
2. `ByteBuf` æ”¯æŒ slice æ“ä½œ, å› æ­¤å¯ä»¥å°† ByteBuf åˆ†è§£ä¸ºå¤šä¸ªå…±äº«åŒä¸€ä¸ªå­˜å‚¨åŒºåŸŸçš„ `ByteBuf`, é¿å…äº†å†…å­˜çš„æ‹·è´ã€‚
3. é€šè¿‡ `FileRegion` åŒ…è£…çš„`FileChannel.tranferTo` å®ç°æ–‡ä»¶ä¼ è¾“, å¯ä»¥ç›´æ¥å°†æ–‡ä»¶ç¼“å†²åŒºçš„æ•°æ®å‘é€åˆ°ç›®æ ‡ `Channel`, é¿å…äº†ä¼ ç»Ÿé€šè¿‡å¾ªç¯ write æ–¹å¼å¯¼è‡´çš„å†…å­˜æ‹·è´é—®é¢˜.
